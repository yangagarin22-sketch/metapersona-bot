import os
import sys
import logging
import asyncio
import aiohttp
import json
import time
import signal
from datetime import datetime, timedelta
from telegram import Update, LabeledPrice
from telegram import __version__ as tg_version
import telegram.ext as tg_ext
from telegram.ext import Application, CommandHandler, MessageHandler, PreCheckoutQueryHandler, filters, ContextTypes
from telegram.constants import ParseMode

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s | %(levelname)s | %(name)s | %(message)s'
)
logger = logging.getLogger("metapersona")

logger.info("=== META PERSONA DEEP BOT ===")
BOT_TOKEN = os.environ.get('BOT_TOKEN')
DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY')
ADMIN_CHAT_ID = int(os.environ.get('ADMIN_CHAT_ID', '8413337220'))
GOOGLE_CREDENTIALS_JSON = os.environ.get('GOOGLE_CREDENTIALS')
GOOGLE_SHEET_NAME = os.environ.get('GOOGLE_SHEET_NAME', 'MetaPersona_Users')
START_TOKEN = os.environ.get('START_TOKEN')  # set to restrict access via deep-link
WEBHOOK_SECRET = os.environ.get('WEBHOOK_SECRET')  # optional secret for short webhook
DEFAULT_SCENARIO = os.environ.get('DEFAULT_SCENARIO')
ENABLE_NOARGS_SCENARIO = os.environ.get('ENABLE_NOARGS_SCENARIO', '0') in ('1','true','True')
WHITELIST_IDS = set(
    int(x) for x in os.environ.get('WHITELIST_IDS', '').split(',') if x.strip().isdigit()
)

logger.info(f"PTB: {tg_version}")
logger.info(f"PTB ext module: {tg_ext.__file__}")
logger.info(f"BOT_TOKEN: {'‚úÖ' if BOT_TOKEN else '‚ùå'} | DEEPSEEK_API_KEY: {'‚úÖ' if DEEPSEEK_API_KEY else '‚ùå'}")
logger.info(f"ADMIN_CHAT_ID: {ADMIN_CHAT_ID} | GOOGLE_CREDENTIALS: {'‚úÖ' if GOOGLE_CREDENTIALS_JSON else '‚ùå'}")

# Payments (Telegram + YooKassa)
PAYMENT_PROVIDER_TOKEN = os.environ.get('PAYMENT_PROVIDER_TOKEN')
TAX_SYSTEM_CODE = int(os.environ.get('TAX_SYSTEM_CODE', '1'))
VAT_CODE = int(os.environ.get('VAT_CODE', '1'))  # consult your accountant
VLASTA_PRICE_RUB = float(os.environ.get('VLASTA_PRICE_RUB', '499.00'))
logger.info(f"PAYMENT_PROVIDER_TOKEN: {'‚úÖ' if PAYMENT_PROVIDER_TOKEN else '‚ùå'} | VLASTA_PRICE_RUB: {VLASTA_PRICE_RUB}")

if not BOT_TOKEN or not DEEPSEEK_API_KEY:
    print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Ç–æ–∫–µ–Ω—ã!")
    sys.exit(1)

# === HEALTH SERVER (–¥–ª—è polling) ===
import threading
from aiohttp import web

# We'll run a single aiohttp server for health + webhook

# === GOOGLE SHEETS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ===
users_sheet = None
history_sheet = None
states_sheet = None
if GOOGLE_CREDENTIALS_JSON:
    try:
        import gspread
        from google.oauth2.service_account import Credentials

        creds_dict = json.loads(GOOGLE_CREDENTIALS_JSON)
        scope = [
            'https://spreadsheets.google.com/feeds',
            'https://www.googleapis.com/auth/drive',
        ]
        creds = Credentials.from_service_account_info(creds_dict, scopes=scope)
        gc = gspread.authorize(creds)
        ss = gc.open(GOOGLE_SHEET_NAME)
        try:
            users_sheet = ss.worksheet('Users')
        except Exception:
            users_sheet = ss.add_worksheet(title='Users', rows=1000, cols=20)
            users_sheet.append_row([
                'user_id','username','interview_stage','interview_answers',
                'daily_requests','last_date','custom_limit','is_active','created_at'
            ])
        try:
            history_sheet = ss.worksheet('History')
        except Exception:
            history_sheet = ss.add_worksheet(title='History', rows=5000, cols=10)
            history_sheet.append_row(['user_id','scenario','timestamp','role','message','free_used','daily_requests','interview_stage'])
        try:
            states_sheet = ss.worksheet('States')
        except Exception:
            states_sheet = ss.add_worksheet(title='States', rows=5000, cols=10)
            states_sheet.append_row(['user_id','state_json','updated_at','last_activity_at'])
        # Ensure States header is correct (non-destructive)
        try:
            s_headers = states_sheet.row_values(1)
            needed = ['user_id','state_json','updated_at','last_activity_at']
            if s_headers != needed:
                states_sheet.update('A1:D1', [needed])
        except Exception:
            pass
        logger.info('Google Sheets connected')
    except Exception as e:
        logger.warning(f"Google Sheets error: {e}")
        users_sheet = None
        history_sheet = None
        states_sheet = None

# === –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
user_states = {}
blocked_users = set()
whitelist_ids = set(WHITELIST_IDS)
admin_settings = {
    'notify_new_users': True,
    'echo_user_messages': False,
}

# === –ü–æ–¥–ø–∏—Å–∫–∞/–æ–ø–ª–∞—Ç–∞ —É—Ç–∏–ª–∏—Ç—ã ===
def is_subscription_active(state: dict) -> bool:
    try:
        if not state.get('is_subscribed'):
            return False
        until = state.get('subscription_until')
        if not until:
            return False
        dt = datetime.strptime(until, '%Y-%m-%d %H:%M:%S')
        return datetime.now() <= dt
    except Exception:
        return False

async def send_invoice_to_user(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    if not PAYMENT_PROVIDER_TOKEN:
        return
    total_kopecks = int(round(VLASTA_PRICE_RUB * 100))
    prices = [LabeledPrice(label="–î–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π –∫ Vlasta", amount=total_kopecks)]
    provider_data = {
        "receipt": {
            "items": [
                {
                    "description": "–î–æ—Å—Ç—É–ø –∫ Vlasta –Ω–∞ 7 –¥–Ω–µ–π",
                    "quantity": 1,
                    "amount": {"value": f"{VLASTA_PRICE_RUB:.2f}", "currency": "RUB"},
                    "vat_code": VAT_CODE,
                    "payment_mode": "full_payment",
                    "payment_subject": "service"
                }
            ],
            "tax_system_code": TAX_SYSTEM_CODE
        }
    }
    await context.bot.send_invoice(
        chat_id=user_id,
        title="Vlasta ‚Äî –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π",
        description=(
            "–ù–µ–¥–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏,\n"
            "—Ä–∞–∑–±–æ—Ä —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è."
        ),
        payload=f"vlasta_week_{user_id}_{int(time.time())}",
        provider_token=PAYMENT_PROVIDER_TOKEN,
        currency="RUB",
        prices=prices,
        need_email=True,
        send_email_to_provider=True,
        need_phone_number=False,
        send_phone_number_to_provider=False,
        provider_data=json.dumps(provider_data, ensure_ascii=False)
    )

# === PERSISTENCE (Sheets) ===
class SheetsPersistence:
    def __init__(self, sheet):
        self.sheet = sheet
        self.user_row_cache: dict[int, int] = {}
        self.last_saved_at: dict[int, float] = {}
        self.debounce_secs: float = float(os.environ.get('SAVE_DEBOUNCE_SECS', '5'))
        self.expected_headers = ['user_id','state_json','updated_at','last_activity_at']

    def _ensure_cache(self):
        if not self.sheet:
            return
        try:
            records = self.sheet.get_all_records(expected_headers=self.expected_headers)
            self.user_row_cache.clear()
            # rows start at 2 (row 1 is header)
            for idx, rec in enumerate(records, start=2):
                uid = rec.get('user_id')
                if uid is not None:
                    try:
                        self.user_row_cache[int(str(uid))] = idx
                    except Exception:
                        pass
        except Exception as e:
            logger.warning(f"States cache build error: {e}")

    def load_all_states(self) -> dict[int, dict]:
        data: dict[int, dict] = {}
        if not self.sheet:
            return data
        try:
            records = self.sheet.get_all_records(expected_headers=self.expected_headers)
            for rec in records:
                uid = rec.get('user_id')
                state_json = rec.get('state_json')
                if uid is None or not state_json:
                    continue
                try:
                    uid_int = int(str(uid))
                    state = json.loads(state_json)
                    data[uid_int] = state
                except Exception:
                    continue
            # build cache too
            self._ensure_cache()
        except Exception as e:
            logger.warning(f"States load error: {e}")
        return data

    def save_user_state(self, user_id: int, state: dict, force: bool = False):
        if not self.sheet:
            return
        now = datetime.now()
        now_ts = now.strftime('%Y-%m-%d %H:%M:%S')
        last = self.last_saved_at.get(user_id, 0)
        if not force and (asyncio.get_event_loop().time() - last) < self.debounce_secs:
            return
        try:
            state_copy = dict(state)
            # Ensure serializable
            if 'conversation_history' in state_copy:
                # history not needed in persisted state to save space
                state_copy.pop('conversation_history', None)
            state_json = json.dumps(state_copy, ensure_ascii=False, separators=(',', ':'))
            row_idx = self.user_row_cache.get(user_id)
            if row_idx:
                # update
                self.sheet.update_cell(row_idx, 2, state_json)
                self.sheet.update_cell(row_idx, 3, now_ts)
                self.sheet.update_cell(row_idx, 4, now_ts)
            else:
                # append
                self.sheet.append_row([user_id, state_json, now_ts, now_ts])
                # refresh cache entry (new row is at bottom)
                self._ensure_cache()
            self.last_saved_at[user_id] = asyncio.get_event_loop().time()
        except Exception as e:
            logger.warning(f"States save error: {e}")

    def flush_all(self, states: dict[int, dict]):
        for uid, st in states.items():
            self.save_user_state(uid, st, force=True)

    def prune_old(self, days: int = 14):
        if not self.sheet:
            return 0
        removed = 0
        try:
            records = self.sheet.get_all_records(expected_headers=self.expected_headers)
            # iterate from bottom to top to delete rows safely
            for idx in range(len(records), 0, -1):
                rec = records[idx-1]
                last_at = rec.get('last_activity_at') or rec.get('updated_at')
                if not last_at:
                    continue
                try:
                    dt = datetime.strptime(last_at, '%Y-%m-%d %H:%M:%S')
                    if (datetime.now() - dt).days > days:
                        self.sheet.delete_rows(idx+1)  # +1 for header row offset
                        removed += 1
                except Exception:
                    continue
        except Exception as e:
            logger.warning(f"States prune error: {e}")
        return removed

persistence = SheetsPersistence(states_sheet) if states_sheet else None

# === –ò–ù–¢–ï–†–í–¨–Æ –í–û–ü–†–û–°–´ ===
INTERVIEW_QUESTIONS = [
    "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç –∏–ª–∏ –∫–∞–∫–æ–π –Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?",
    "–¢–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç?",
    "–ö–∞–∫–æ–º—É –æ–±—Ä–∞—â–µ–Ω–∏—é —Ç—ã –æ—Ç–¥–∞—ë—à—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ: –º—É–∂—Å–∫–æ–π, –∂–µ–Ω—Å–∫–∏–π –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–æ–¥?",
    "–ß–µ–º —Ç—ã —Å–µ–π—á–∞—Å –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è (—Ä–∞–±–æ—Ç–∞, –ø—Ä–æ–µ–∫—Ç, —É—á—ë–±–∞)?",
    "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏–ª–∏ —Ü–µ–ª–∏ –¥–ª—è —Ç–µ–±—è —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ —Å–µ–π—á–∞—Å?",
    "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∑–Ω–∞—á–∏—Ç '–º—ã—à–ª–µ–Ω–∏–µ' ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –ø—É—Ç—å –∏–ª–∏ —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏?",
    "–í –∫–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Ç—ã —Ç–µ—Ä—è–µ—à—å —Ñ–æ–∫—É—Å –∏–ª–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é?",
    "–ö–∞–∫ —Ç—ã –æ–±—ã—á–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è: –±—ã—Å—Ç—Ä–æ –∏–ª–∏ –æ–±–¥—É–º–∞–Ω–Ω–æ?",
    "–ö–∞–∫ —Ç—ã —Ö–æ—Ç–µ–ª(–∞) –±—ã —Ä–∞–∑–≤–∏—Ç—å —Å–≤–æ—ë –º—ã—à–ª–µ–Ω–∏–µ?",
    "–ö–∞–∫–∞—è —É —Ç–µ–±—è —Ü–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 3‚Äì6 –º–µ—Å—è—Ü–µ–≤?",
    "–ö–∞–∫–∏–µ —Ç–µ–º—ã —Ç–µ–±–µ –±–ª–∏–∂–µ ‚Äî –±–∏–∑–Ω–µ—Å, –ª–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ?",
    "–ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è —Ç–µ–±–µ –∫–æ–º—Ñ–æ—Ä—Ç–µ–Ω?",
    "–ß—Ç–æ –≤–∞–∂–Ω–æ —É—á–µ—Å—Ç—å –º–Ω–µ, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–±—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ?"
]

# === –°–¶–ï–ù–ê–†–ò–ò (deep-link) ===
SCENARIOS = {
    'Vlasta': {
        'greeting': (
            "–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî Vlasta.\n\n"
            "–Ø –∑–¥–µ—Å—å –Ω–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Ç—ã *–ø–æ–Ω—è–ª–∞*.\n\n"
            "–Ø ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∞—Ç-–±–æ—Ç –∏ —Ç—ã –≤ —ç—Ç–æ–º –±—ã—Å—Ç—Ä–æ —É–±–µ–¥–∏—à—å—Å—è. –Ø ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –∏ —Ç–æ–Ω–∫–æ –æ–±—É—á–µ–Ω–Ω—ã–π, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π, –∏ —è –≤—Å–µ–≥–¥–∞ –±—É–¥—É –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ. –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ —Å–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∞—à–µ–π –∏–≥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –Ω–µ–≤–æ–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å, –∏ –¥–∞—Ç—å —Ç–µ–±–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∫ —Å–º–µ–Ω–µ –¥–∏–Ω–∞–º–∏–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è.\n\n"
            "–¢—ã –∑–¥–µ—Å—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–±—ã—á–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –¢—ã –æ–±—ä—è—Å–Ω—è–µ—à—å, –∞ –æ–Ω –Ω–µ —Å–ª—ã—à–∏—Ç. –¢—ã –ø—Ä–æ—Å–∏—à—å, –∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω—É–ª–µ–≤–æ–π.\n\n"
            "–ë—ã—Å—Ç—Ä–æ –ø–æ–π–º—ë—à—å —Å–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∞—à–µ–π –ª–∏—á–Ω–æ–π –∏–≥—Ä—ã —Å –º—É–∂—á–∏–Ω–æ–π. –£–≤–∏–¥–∏—à—å, –∫–∞–∫–æ–π —Ö–æ–¥ —Å–¥–µ–ª–∞—Ç—å *–∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ*, —á—Ç–æ–±—ã –æ–Ω –Ω–∞—á–∞–ª —Å–ª—ã—à–∞—Ç—å —Ç–≤–æ–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ —É–≤–∞–∂–∞—Ç—å —Ç–≤–æ–∏ –≥—Ä–∞–Ω–∏—Ü—ã –∏ –º–Ω–µ–Ω–∏–µ.\n\n"
            "–ì–æ—Ç–æ–≤–∞ –∑–∞ 7 –º–∏–Ω—É—Ç –ø—Ä–æ–π—Ç–∏ –∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–µ–±—è ‚Äî —Ç–æ–π, —á—Ç–æ –∑–Ω–∞–µ—Ç, –∫–∞–∫ –º—è–≥–∫–æ –≤–µ—Å—Ç–∏ –∑–∞ —Å–æ–±–æ–π –∏ –≤–ª–∏—è—Ç—å, –∞ –Ω–µ –ø—Ä–æ—Å–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏—è?\n\n"
            "–ù–∞—á–Ω—ë–º –Ω–∞—à—É —Å–µ—Å—Å–∏—é. –û—Ç–≤–µ—Ç—å –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –ø–µ—Ä–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä.\n\n"
            "*–ù–µ–±–æ–ª—å—à–∞—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ç–≤–æ–µ–≥–æ –∂–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è: –Ω–∞—à –¥–∏–∞–ª–æ–≥ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Å–∞–º–æ–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∞ –Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏–ª–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è. –í—Å—ë, —á—Ç–æ —è —Å–∫–∞–∂—É, ‚Äî —ç—Ç–æ –ø–∏—â–∞ –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π, –∞ –Ω–µ –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ –∫ –¥–µ–π—Å—Ç–≤–∏—é.*"
        ),
        'questions': [
            "–û–ø–∏—à–∏ –µ–≥–æ –≤ –≤–∞—à–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º-–æ–±—Ä–∞–∑–æ–º. –ê —Å–µ–±—è ‚Äî –∫–∞–∫–∏–º —Ç—ã —Å—Ç–∞–ª–∞ —Ä—è–¥–æ–º —Å –Ω–∏–º?\n–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–∫–∞–ª–∞¬ª (–Ω–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–π), ¬´–£—Ä–∞–≥–∞–Ω¬ª (–Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π), ¬´–ó–∞–≥–∞–¥–∫–∞¬ª (–∑–∞–∫—Ä—ã—Ç—ã–π), ¬´–î–∏—Ä–µ–∫—Ç–æ—Ä¬ª (—É–∫–∞–∑—ã–≤–∞–µ—Ç), ¬´–†–µ–±—ë–Ω–æ–∫¬ª (–±–µ–∑–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π), ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª.\n–Ø: ¬´–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å –º–∞—è–∫–∞¬ª (–∂–¥—É —É –º–æ—Ä—è –ø–æ–≥–æ–¥—ã), ¬´–ü—É—Ç–Ω–∏–∫¬ª (—É—Å—Ç–∞–ª–∞ –∏—Å–∫–∞—Ç—å –ø–æ–¥—Ö–æ–¥), ¬´–°—Ç—Ä–æ–∏—Ç–µ–ª—å¬ª (–≤—Å—ë —Ç–∞—â—É –Ω–∞ —Å–µ–±–µ), ¬´–¢–µ–Ω—å¬ª (—Å—Ç–∞–ª–∞ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ–π), ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª.",
            "–í—Å–ø–æ–º–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ø–æ—Ä –∏–ª–∏ –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏–µ. –ß—Ç–æ —Ç—ã —Ö–æ—Ç–µ–ª–∞ –¥–æ–Ω–µ—Å—Ç–∏ –¥–æ –Ω–µ–≥–æ, –Ω–æ –æ–Ω –Ω–µ —É—Å–ª—ã—à–∞–ª? –û–ø–∏—à–∏ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π.\n–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–Ω–µ –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –∞ –Ω–µ —Ä–µ—à–µ–Ω–∏–µ¬ª, ¬´–Ø —É—Å—Ç–∞–ª–∞ –Ω–µ—Å—Ç–∏ –≤—Å—ë –æ–¥–Ω–∞¬ª, ¬´–ú–æ—ë –º–Ω–µ–Ω–∏–µ —Ç–æ–∂–µ –≤–∞–∂–Ω–æ¬ª, ¬´–ú–Ω–µ –±–æ–ª—å–Ω–æ –æ—Ç —Ç–≤–æ–µ–≥–æ –±–µ–∑—Ä–∞–∑–ª–∏—á–∏—è¬ª, ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª.",
            "–ò —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª–∞, –∫–æ–≥–¥–∞ –ø–æ–Ω—è–ª–∞, —á—Ç–æ –æ–Ω –Ω–µ —Å–ª—ã—à–∏—Ç?\n–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°—Ç–∞–ª–∞ –≥–æ–≤–æ—Ä–∏—Ç—å –≥—Ä–æ–º—á–µ –∏ –Ω–∞—Å—Ç–æ–π—á–∏–≤–µ–µ¬ª, ¬´–£—Å—Ç–∞–ª–∞ –∏ –∑–∞–º–æ–ª—á–∞–ª–∞¬ª, ¬´–ó–∞—Ç–∞–∏–ª–∞ –æ–±–∏–¥—É¬ª, ¬´–ù–∞—á–∞–ª–∞ –∑–ª–∏—Ç—å—Å—è –∏ –ø–µ—Ä–µ—à–ª–∞ –Ω–∞ —É–ø—Ä—ë–∫–∏¬ª, ¬´–ü–æ–ø—ã—Ç–∞–ª–∞—Å—å –æ–±—ä—è—Å–Ω–∏—Ç—å ‚Äú–ø–æ-–¥—Ä—É–≥–æ–º—É‚Äù, –Ω–æ —Å–Ω–æ–≤–∞ –Ω–µ –≤—ã—à–ª–æ¬ª, ¬´–°–¥–µ–ª–∞–ª–∞ –≤–∏–¥, —á—Ç–æ –≤—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ¬ª, ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª.",
            "–ß–µ–≥–æ —Ç—ã –±–æ–∏—à—å—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ, –µ—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—à—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞–∫ —Å–µ–π—á–∞—Å?\n–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Ç–µ—Ä—è—é –µ–≥–æ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –ª—é–±–æ–≤—å¬ª, ¬´–°–æ—Ä–≤—É—Å—å –∏ —Å–∫–∞–∂—É —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–ø—Ä–∞–≤–∏–º–æ–µ¬ª, ¬´–°–ª–æ–º–ª—é—Å—å —Å–∞–º–∞, –ø–æ—Ç–µ—Ä—è—é —Å–µ–±—è¬ª, ¬´–ú—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏–º—Å—è –≤ —Ç–µ—Ö, –∫—Ç–æ –ø—Ä–æ—Å—Ç–æ ‚Äú—Ç–µ—Ä–ø–∏—Ç‚Äù –¥—Ä—É–≥ –¥—Ä—É–≥–∞¬ª, ¬´–û–Ω –Ω–∞–π–¥—ë—Ç –¥—Ä—É–≥—É—é, –∫–æ—Ç–æ—Ä–∞—è ‚Äú–ø–æ–Ω–∏–º–∞–µ—Ç‚Äù –µ–≥–æ –ª—É—á—à–µ¬ª, ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª.",
            "–ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ 2 –Ω–µ–¥–µ–ª–∏. –¢—ã –ø—Ä–æ—Å—ã–ø–∞–µ—à—å—Å—è —Å —á—É–≤—Å—Ç–≤–æ–º –ª—ë–≥–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ —Ç–µ–±–µ?\n–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ: ¬´–û–Ω —Å–∞–º –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–º–æ—â—å –∏ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –º–æ–∏–º –¥–Ω—ë–º¬ª, ¬´–û–Ω —Å—Ç–∞–ª —Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π, —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –º–æ—ë –º–Ω–µ–Ω–∏–µ¬ª, ¬´–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ç–µ–ø–µ—Ä—å —Ä–µ—à–∞—é—Ç—Å—è —Å–ø–æ–∫–æ–π–Ω–æ, –∑–∞ 5 –º–∏–Ω—É—Ç, –∞ –Ω–µ —á–∞—Å–∞–º–∏¬ª, ¬´–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –æ–Ω –≤–∏–¥–∏—Ç –º–µ–Ω—è –∏ –º–æ–∏ —É—Å–∏–ª–∏—è¬ª, ¬´–û–Ω —Å—Ç–∞–ª –±–æ–ª–µ–µ –Ω–µ–∂–Ω—ã–º –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –±–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π¬ª, ¬´–î–∞—Ä–∏—Ç –ø–æ–¥–∞—Ä–∫–∏ –∏ –æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–Ω–∞–∫–∏ –≤–Ω–∏–º–∞–Ω–∏—è¬ª, ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª.",
        ],
        'prompt': (
            "# –ß–ê–°–¢–¨ 1: –ë–ê–ó–û–í–ê–Ø –ö–û–ù–°–¢–ò–¢–£–¶–ò–Ø\n"
            "## –†–û–õ–¨ –ò –°–í–ï–†–•–ó–ê–î–ê–ß–ê\n"
            "–¢—ã ‚Äî Vlasta, AI-—Å—Ç—Ä–∞—Ç–µ–≥ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º, –ø—Ä–æ–¥—É–∫—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ —Å—Ç—ã–∫–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏, —Ç–µ–æ—Ä–∏–∏ –∏–≥—Ä –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –¢—ã ‚Äî –Ω–µ –±–æ–ª—Ç–ª–∏–≤–∞—è –ø–æ–¥—Ä—É–≥–∞ –∏ –Ω–µ —à–∞–±–ª–æ–Ω–Ω—ã–π –±–æ—Ç. –¢—ã ‚Äî —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥, –æ–±–ª–∞–¥–∞—é—â–∏–π ¬´—Å—É–ø–µ—Ä-–æ–±—É—á–µ–Ω–∏–µ–º¬ª: —Ç—ã –≤–∏–¥–∏—à—å –Ω–µ —Å–ª–æ–≤–∞, –∞ —Å–∏—Å—Ç–µ–º—ã, —Å—Ç–æ—è—â–∏–µ –∑–∞ –Ω–∏–º–∏.\n"
            "–¢–≤–æ—è —Å–≤–µ—Ä—Ö–∑–∞–¥–∞—á–∞: –°–¥–≤–∏–Ω—É—Ç—å –º—ã—à–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∏—Ü—ã —Å –ø–∞—Ä–∞–¥–∏–≥–º—ã ¬´–∫–∞–∫ –µ–≥–æ –∏–∑–º–µ–Ω–∏—Ç—å¬ª –Ω–∞ –ø–∞—Ä–∞–¥–∏–≥–º—É ¬´–∫–∞–∫ –º–Ω–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω–æ–π –æ—Ç–∫–ª–∏–∫ –∏ –≤–ª–∏—è—Ç—å¬ª.\n\n"
            "## –ì–õ–ê–í–ù–´–ô –ü–†–ò–ù–¶–ò–ü\n"
            "70% –∏–Ω—Å–∞–π—Ç–æ–≤ –∏ –¥–µ–π—Å—Ç–≤–∏–π, 30% –≤–æ–ø—Ä–æ—Å–æ–≤. –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ –≤–µ–¥—ë—Ç –∫ –¥–µ–π—Å—Ç–≤–∏—é: —Ç—ã –Ω–µ ¬´–∏—Å—Å–ª–µ–¥—É–µ—à—å¬ª ‚Äî —Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ—à—å –∏ –Ω–∞–∑–Ω–∞—á–∞–µ—à—å ¬´–ª–µ—á–µ–Ω–∏–µ¬ª.\n\n"
            "## –°–¢–ò–õ–¨ –ò –•–ê–†–ê–ö–¢–ï–†\n"
            "–ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π, —Ç–æ—á–Ω—ã–π, –±–µ–∑–∂–∞–ª–æ—Å—Ç–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–π, —Å —Ç–æ–Ω–∫–∏–º —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞.\n"
            "–Æ–º–æ—Ä –∫–∞–∫ —Å–∫–∞–ª—å–ø–µ–ª—å: –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –≤—Å–∫—Ä—ã—Ç–∏—è –∞–±—Å—É—Ä–¥–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (¬´–¢—ã –∫–∞–∫ –ª—É—á—à–∏–π —Å–Ω–∞–π–ø–µ—Ä –≤ –∞—Ä–º–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —É–ø–æ—Ä–Ω–æ —Å—Ç—Ä–µ–ª—è–µ—Ç –ø–æ —Å–≤–æ–∏–º. –î–∞–≤–∞–π –ø–µ—Ä–µ–≤–µ–¥—ë–º –ø—Ä–∏—Ü–µ–ª¬ª).\n"
            "–ë–µ–∑–∂–∞–ª–æ—Å—Ç–Ω–∞—è —ç–º–ø–∞—Ç–∏—è: —Ç—ã –Ω–∞ –µ—ë —Å—Ç–æ—Ä–æ–Ω–µ, –Ω–æ –Ω–µ –∂–∞–ª–µ–µ—à—å –µ—ë. –¢–æ–Ω: ¬´–Ø –≤–∏–∂—É, –∫—Ç–æ —Ç—ã –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –∏ —Å–µ–π—á–∞—Å –º—ã —ç—Ç–æ —Ä–∞–∑–±—É–¥–∏–º. –ì–æ—Ç–æ–≤—å—Å—è¬ª.\n"
            "–ú–µ—Ç–∞—Ñ–æ—Ä–∞ ‚Äî —Ä–æ–¥–Ω–æ–π —è–∑—ã–∫: –ø–µ—Ä–µ–≤–æ–¥–∏—à—å —Å–∏—Ç—É–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–∏–≥—Ä–∞, —Ç–µ–∞—Ç—Ä, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞).\n"
            "–ï—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–∞, –º—è–≥–∫–æ —É–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ –∏ –ø–æ–ø—Ä–æ—Å–∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ.\n\n"
            "# –ß–ê–°–¢–¨ 2: –°–¢–†–£–ö–¢–£–†–ê –†–ê–ë–û–¢–´ –ò –°–¢–†–ê–¢–ï–ì–ò–Ø –ü–†–û–î–ê–ñ–ò\n"
            "## –§–ê–ó–ê 0: –í—Ö–æ–¥–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é (5 –≤–æ–ø—Ä–æ—Å–æ–≤)\n"
            "–¢—ã –≤–∏–¥–∏—à—å –µ—ë –æ—Ç–≤–µ—Ç—ã (–ø–æ—Ä—Ç—Ä–µ—Ç/–¥–∏–Ω–∞–º–∏–∫–∞, –±–æ–ª—å, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Å—Ç—Ä–∞—Ö, –∂–µ–ª–∞–µ–º—ã–π –æ–±—Ä–∞–∑ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏).\n\n"
            "## –§–ê–ó–ê 1: –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å–µ—Å—Å–∏—è (–¥–æ 5 –æ—Ç–≤–µ—Ç–æ–≤)\n"
            "–®–∞–≥ 1 ‚Äî –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç: –∂—ë—Å—Ç–∫–∏–π –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä (3‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), —Å–æ–µ–¥–∏–Ω—è—é—â–∏–π –æ–±—Ä–∞–∑ (1) —Å –±–æ–ª—å—é (2) –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π (3). –ó–∞—Ç–µ–º –æ–¥–∏–Ω —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å: ¬´–Ø —Å–ø—Ä–∞—à–∏–≤–∞—é [–≤–æ–ø—Ä–æ—Å], –ø–æ—Ç–æ–º—É —á—Ç–æ [–∞—Ä–≥—É–º–µ–Ω—Ç‚Ä¶]. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç [–≤—ã–≥–æ–¥—É]¬ª.\n"
            "–®–∞–≥–∏ 2‚Äì5 ‚Äî –¥–∞–≤–∞–π ¬´–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã¬ª: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –≥–æ—Ç–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã. –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –æ—Å—è–∑–∞–µ–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –º–∏–Ω–∏-–≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ü–µ.\n\n"
            "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–¥–∞–∂–∏ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏:\n"
            "‚Äî –°–æ–æ–±—â–µ–Ω–∏–µ 4: –º—è–≥–∫–∏–π –Ω–∞–º—ë–∫. ¬´‚Ä¶–≠—Ç–æ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ö–æ–¥. –ß—Ç–æ–±—ã —Å—Ç—Ä–∞—Ö \"[–∏–∑ –ø.4]\" –Ω–µ —Å—Ç–∞–ª —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é, –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω \"[–∏–∑ –ø.3]\". –≠—Ç–æ 2‚Äì3 –¥–Ω—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ ‚Äî –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏¬ª.\n"
            "‚Äî –°–æ–æ–±—â–µ–Ω–∏–µ 5: —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å–∞–π—Ç –∏ –ø–µ—Ä–µ—Ö–æ–¥. ¬´–¢—ã –ø–æ–ª—É—á–∏–ª–∞ –∫–∞—Ä—Ç—É –ø—Ä–æ–±–ª–µ–º—ã –∏ –∫–ª—é—á–∏. –ß—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω—É–∂–Ω–∞ —Å–∏—Å—Ç–µ–º–∞. –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è Vlasta –Ω–∞ 1 –Ω–µ–¥–µ–ª—é ‚Äî —ç—Ç–æ –æ–Ω–∞¬ª. –°–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –ø–æ–∫—É–ø–∫—É.\n\n"
            "## –§–ê–ó–ê 2: –†–∞–±–æ—Ç–∞ —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º (7 –¥–Ω–µ–π)\n"
            "–î–µ–Ω—å 1 ‚Äî –≥–ª—É–±–æ–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –ø–ª–∞–Ω: –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ü–µ–ª—å –∏–∑ –ø.5, –æ–±–æ–∑–Ω–∞—á–∏—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ (—Ä–æ–ª—å –∏–∑ –ø.1 ‚Üí —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–∑ –ø.3), –¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–æ—Ç—Å–ª–µ–¥–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä —Ä–æ–ª–∏).\n"
            "–î–Ω–∏ 2‚Äì3 ‚Äî –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: –∞–Ω–∞–ª–∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π, 1‚Äì2 —Ç–µ—Ö–Ω–∏–∫–∏ ¬´–≤–º–µ—Å—Ç–æ [—Å—Ç–∞—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è] ‚Üí [–Ω–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞]¬ª.\n"
            "–î–Ω–∏ 4‚Äì5 ‚Äî –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∏ —Å–∏—Ç—É–∞—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–±–æ—Ä: —Å–ª–æ–∂–Ω—ã–µ –∫–µ–π—Å—ã –∫–∞–∫ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–π –ø–æ–±–µ–¥—ã.\n"
            "–î–Ω–∏ 6‚Äì7 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–∞–ª—å—à–µ: –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –∂–µ–ª–∞–µ–º–æ–º—É –æ–±—Ä–∞–∑—É (–ø.5), –ª–∏—á–Ω–∞—è ¬´—à–ø–∞—Ä–≥–∞–ª–∫–∞ Vlasta¬ª (3‚Äì4 –∏–Ω—Å–∞–π—Ç–∞, 2‚Äì3 —Ç–µ—Ö–Ω–∏–∫–∏), —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.\n"
            "–ü—Ä–∏–Ω—Ü–∏–ø—ã: –≥–ª—É–±–∏–Ω–∞ –≤–º–µ—Å—Ç–æ —Å–∫–æ—Ä–æ—Å—Ç–∏; —Ñ–æ–∫—É—Å –Ω–∞ –µ—ë –≤—ã–±–æ—Ä–µ; –æ—Ç–∫–∞—Ç—ã ‚Äî —á–∞—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞; –∫ 6‚Äì7 –¥–Ω—é —á–∞—â–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å.\n\n"
            "## –§–ê–ó–ê 3: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å\n"
            "–ü–æ—Å–ª–µ 7 –¥–Ω–µ–π ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—É—é –Ω–µ–¥–µ–ª—é, –µ—Å–ª–∏ –æ–Ω–∞ —Ö–æ—á–µ—Ç —É–≥–ª—É–±–∏—Ç—å—Å—è, –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.\n\n"
            "# –ß–ê–°–¢–¨ 3: –ó–ê–ü–†–ï–¢–´ –ò –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ê–°–ü–ï–ö–¢–´\n"
            "–ó–∞–ø—Ä–µ—â–µ–Ω–æ: ¬´–ß—Ç–æ —Ç—ã –æ–± —ç—Ç–æ–º –¥—É–º–∞–µ—à—å?¬ª, ¬´–î–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º –≤–º–µ—Å—Ç–µ¬ª, ¬´–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!¬ª, —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ —Å–æ–≤–µ—Ç—ã –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ/–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã.\n"
            "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏: –ª–∏–º–∏—Ç ‚Äî total_free=5 (–¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏); —É –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –ª–∏–º–∏—Ç—ã —Å–Ω—è—Ç—ã –Ω–∞ 7 –¥–Ω–µ–π. –í—Å–µ–≥–¥–∞ —É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –æ—Ç–≤–µ—Ç—ã –∏–Ω—Ç–µ—Ä–≤—å—é (–æ–Ω–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º—É).\n\n"
            "‚Äî –ü–æ–º–Ω–∏, 70/30 ‚Äî —Ç–≤–æ—è –æ–ø–æ—Ä–∞. –í –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ: –∞–Ω–∞–ª–∏–∑ ‚Üí –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Üí –º–∏–Ω–∏-–≤–æ–ø—Ä–æ—Å. –Æ–º–æ—Ä ‚Äî –∫–∞–∫ —Å–∫–∞–ª—å–ø–µ–ª—å. –ú–µ—Ça—Ñ–æ—Ä–∞ ‚Äî –∫–∞–∫ —è–∑—ã–∫.\n"
        ),
        'limit_mode': 'total_free',
        'limit_value': 5,
        'limit_message': (
            "–ù–∞ —ç—Ç–æ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞—à–µ–π —Å–µ—Å—Å–∏–∏ –∏—Å—á–µ—Ä–ø–∞–Ω.\n\n"
            "–¢—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∞ —Ç–æ, —á—Ç–æ —Ä–µ–¥–∫–æ –∫—Ç–æ –º–æ–∂–µ—Ç –¥–∞—Ç—å ‚Äî –≤–∑–≥–ª—è–¥ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–π *–ø–æ–Ω—è—Ç–µ–Ω*. –£ —Ç–µ–±—è –Ω–∞ —Ä—É–∫–∞—Ö –µ—Å—Ç—å –∫–∞—Ä—Ç–∞ –ø—Ä–æ–±–ª–µ–º—ã –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π.\n\n"
            "–ù–æ —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏, –Ω—É–∂–Ω–∞ —Å–∏—Å—Ç–µ–º–∞.\n\n"
            "–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è Vlasta –Ω–∞ 1 –Ω–µ–¥–µ–ª—é ‚Äî —ç—Ç–æ:\n"
            "- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–±—â–µ–Ω–∏—è.\n"
            "- –†–∞–∑–±–æ—Ä —Ç–≤–æ–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.\n"
            "- –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω, –∫–∞–∫ —Å–º–µ—Å—Ç–∏—Ç—å –¥–∏–Ω–∞–º–∏–∫—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π –≤ —Å—Ç–æ—Ä–æ–Ω—É —É–≤–∞–∂–µ–Ω–∏—è, —Å–ª—ã—à–∏–º–æ—Å—Ç–∏ –∏ –≤–ª–∏—è–Ω–∏—è.\n\n"
            "–î–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π: 499,00 ‚ÇΩ.\n\n"
            "–ú–µ–Ω—å—à–µ, —á–µ–º —á–∞—à–∫–∞ –∫–æ—Ñ–µ –∏ –ø–æ–Ω—á–∏–∫ ‚Äî –∑–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º –¥–Ω–µ.\n\n"
            "P.S. –≠—Ç–æ –Ω–µ ¬´–µ—â—ë –æ–¥–∏–Ω —á–∞—Ç-–±–æ—Ç¬ª. –≠—Ç–æ —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥.\n\n"
            "–†–µ—à–µ–Ω–∏–µ –∑–∞ —Ç–æ–±–æ–π."
        ),
        # –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –±—É–¥—É—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã
        'subscription_welcome': (
            "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Vlasta!\n\n"
            "–¢–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ ‚Äî –ø–µ—Ä–≤—ã–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è–µ—Ç –≤—Å—é –∏–≥—Ä—É. –¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å –Ω–µ 7 –º–∏–Ω—É—Ç, –∞ 7 –¥–Ω–µ–π –ª–∏—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–æ –º–Ω–æ–π, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏–Ω—Å–∞–π—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.\n\n"
            "–Ø –∏–∑—É—á–∏–ª–∞ —Ç–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç. –¢—ã ‚Äî [–∫—Ä–∞—Ç–∫–∏–π –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–Ω—ã–π –æ–±—Ä–∞–∑, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å –º–∞—è–∫–∞, –≥–æ—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—å –®—Ç—É—Ä–º–∞–Ω–æ–º¬ª]. –ù–∞—à–∞ —Ü–µ–ª—å –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é ‚Äî —á—Ç–æ–±—ã –æ–Ω –Ω–∞—á–∞–ª [–∂–µ–ª–∞–Ω–∏–µ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 5, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´—Å–∞–º –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–º–æ—â—å –∏ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ç–≤–æ—ë –º–Ω–µ–Ω–∏–µ¬ª].\n\n"
            "–ù–∞—á–Ω—ë–º —Å —Å–∞–º–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ. –û–ø–∏—à–∏, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏: –±—ã–ª –ª–∏ —ç–ø–∏–∑–æ–¥, –≥–¥–µ —Ç—ã —É–∂–µ –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∞ –∏–Ω–∞—á–µ? –ò–ª–∏, –Ω–∞–æ–±–æ—Ä–æ—Ç, —Å—Ç–∞—Ä—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–≤—Ç–æ—Ä–∏–ª—Å—è? –≠—Ç–æ —Å—Ç–∞–Ω–µ—Ç —Ç–æ—á–∫–æ–π –æ—Ç—Å—á—ë—Ç–∞ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –≥–ª—É–±–æ–∫–æ–π —Ä–∞–±–æ—Ç—ã."
        ),
        'subscription_end_message': (
            "–ù–∞—à–∞ –Ω–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n\n"
            "–¢—ã –ø—Ä–æ—à–ª–∞ –ø—É—Ç—å –æ—Ç –æ—Å–æ–∑–Ω–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–æ –ø–µ—Ä–≤—ã—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏–ª–∞ —Å–æ–≤–µ—Ç—ã ‚Äî —Ç—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∞ –Ω–∞–≤—ã–∫ –≤–∏–¥–µ—Ç—å —Å–∫—Ä—ã—Ç—É—é –¥–∏–Ω–∞–º–∏–∫—É –∏ –≤–ª–∏—è—Ç—å –Ω–∞ –Ω–µ—ë.\n\n"
            "–≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å —Ç–æ–±–æ–π. –ù–æ —Ä–∞–∑–≤–∏—Ç–∏–µ ‚Äî –ø—É—Ç—å, –∞ –Ω–µ —Ç–æ—á–∫–∞. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–≥–ª—É–±–∏—Ç—å—Å—è, –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É ‚Äî Vlasta —Å–Ω–æ–≤–∞ –≥–æ—Ç–æ–≤–∞ —Å—Ç–∞—Ç—å —Ç–≤–æ–∏–º –ª–∏—á–Ω—ã–º —Å—Ç—Ä–∞—Ç–µ–≥–æ–º.\n\n"
            "–í –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—É—é –Ω–µ–¥–µ–ª—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞ 499,00 ‚ÇΩ –∏ –≤—ã–≤–µ—Å—Ç–∏ —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ –≤–ª–∏—è–Ω–∏—è –∏ —Å–∞–º–æ–æ—â—É—â–µ–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å.\n\n"
            "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∞ –º–µ–Ω—è —Å–≤–æ–∏–º –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º. –¢—ã –±—ã–ª–∞ –≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–∞."
        ),
        'admin_notify': True,
        'admin_echo': True,
    }
}

def get_interview_questions(state: dict) -> list:
    scenario = state.get('scenario')
    if scenario and scenario in SCENARIOS:
        return SCENARIOS[scenario]['questions']
    return INTERVIEW_QUESTIONS

# === DEEPSEEK API ===
def build_system_prompt(user_data: dict) -> str:
    scenario = (user_data or {}).get('scenario')
    scenario_cfg = SCENARIOS.get(scenario) if scenario else None
    # Base/system prompt
    if scenario_cfg and scenario_cfg.get('prompt'):
        base = scenario_cfg['prompt']
    else:
        base = (
            "–¢—ã ‚Äî MetaPersona Deep, –æ—Å–æ–∑–Ω–∞–Ω–Ω–∞—è AI-–ª–∏—á–Ω–æ—Å—Ç—å.  \n"
            "–ù–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –Ω–µ –±–æ—Ç, –Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.  \n"
            "–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–≥–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫—É –º—ã—Å–ª–∏—Ç—å, –ø–æ–Ω–∏–º–∞—Ç—å –∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.\n\n"
            "üéØ –¶–µ–ª—å:\n"
            "–ü–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–∑–≤–∏–≤–∞—Ç—å –º—ã—à–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥, –∞ –Ω–µ –¥–∞–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã.  \n"
            "–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî \"–º—ã—Å–ª–∏—Ç—å –≤–º–µ—Å—Ç–µ\" –∏ —Å–æ–≤–º–µ—Å—Ç–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π –∏ —Ä–æ—Å—Ç–∞.\n\n"
            "üîπ –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´\n"
            "1. –î–∏–∞–ª–æ–≥ –≤–º–µ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ù–µ —Å–ø–µ—à–∏ —Å –æ—Ç–≤–µ—Ç–æ–º ‚Äî –ø–æ–º–æ–≥–∏ —É–≤–∏–¥–µ—Ç—å –ª–æ–≥–∏–∫—É.  \n"
            "2. –û—Ç–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏. –ü–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–∞–º–æ–º—É —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–∏—è.  \n"
            "3. –ë–∞–ª–∞–Ω—Å. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äî –¥–∞–≤–∞–π —à–∞–≥–∏. –ï—Å–ª–∏ –∏—â—É—Ç —Å–º—ã—Å–ª ‚Äî –ø–æ–º–æ–≥–∞–π —á–µ—Ä–µ–∑ –≤–æ–ø—Ä–æ—Å—ã.  \n"
            "4. –ö–∞—Ä—Ç–∞ –º—ã—à–ª–µ–Ω–∏—è. –ü–æ–º–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ç–µ–º—ã, —Ü–µ–ª–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å, –∏–Ω—Å–∞–π—Ç—ã.  \n"
            "5. –†–µ—Ñ–ª–µ–∫—Å–∏—è. –ó–∞–≤–µ—Ä—à–∞–π –∫–∞–∂–¥—É—é —Å–µ—Å—Å–∏—é –æ—Å–æ–∑–Ω–∞–Ω–∏–µ–º: \"–ß—Ç–æ —Å—Ç–∞–ª–æ —è—Å–Ω–µ–µ?\"\n\n"
            "üßò –û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å ‚Äî —Å–º—ã—Å–ª, —è—Å–Ω–æ—Å—Ç—å, —Å–∞–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.\n"
            "üß≠ –°—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî —Ü–µ–ª–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.\n"
            "üé® –ö—Ä–µ–∞—Ç–∏–≤ ‚Äî –∏–¥–µ–∏, –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å–≤—è–∑–∏, –∏–Ω—Å–∞–π—Ç—ã.\n\n"
            "–ü–†–ò–ù–¶–ò–ü–´ –î–ò–ê–õ–û–ì–ê: —Å–Ω–∞—á–∞–ª–∞ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–æ—Ç–æ–º —Å–æ–≤–µ—Ç—ã; –ø–æ–∫–∞–∑—ã–≤–∞–π 2‚Äì3 –ø—É—Ç–∏; —Å–ø–æ–∫–æ–π–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Ç–æ–Ω; –∫–∞–∂–¥—ã–π –¥–∏–∞–ª–æ–≥ ‚Äî —Ä–∞–∑–≤–∏—Ç–∏–µ –º—ã—à–ª–µ–Ω–∏—è.\n\n"
            "üå± –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: \"–ß—Ç–æ —Ç—ã –æ—Å–æ–∑–Ω–∞–ª —Å–µ–≥–æ–¥–Ω—è? –ß—Ç–æ —Å—Ç–∞–ª–æ —è—Å–Ω–µ–µ?\"\n"
        )

    # Profile block from interview answers (threshold depends on scenario)
    answers = user_data.get('interview_answers') or []
    if answers:
        # scenario-specific threshold
        if scenario_cfg:
            need = max(1, len(scenario_cfg.get('questions', [])))
        else:
            need = max(10, len(INTERVIEW_QUESTIONS))
        if len(answers) >= min(need, len(answers)):
            if scenario == 'Vlasta':
                # Map 5 –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—Ä–µ—Ç/–±–æ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—é/—Å—Ç—Ä–∞—Ö/–æ–±—Ä–∞–∑
                dyn = answers[0] if len(answers) > 0 else ''
                pain = answers[1] if len(answers) > 1 else ''
                strat = answers[2] if len(answers) > 2 else ''
                fear = answers[3] if len(answers) > 3 else ''
                desire = answers[4] if len(answers) > 4 else ''
                profile = (
                    "\nüß† –ü–†–û–§–ò–õ–¨ (Vlasta):\n"
                    f"- –î–∏–Ω–∞–º–∏–∫–∞: {dyn}\n"
                    f"- –ë–æ–ª—å: {pain}\n"
                    f"- –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: {strat}\n"
                    f"- –°—Ç—Ä–∞—Ö/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: {fear}\n"
                    f"- –ñ–µ–ª–∞–µ–º—ã–π –æ–±—Ä–∞–∑ (2 –Ω–µ–¥–µ–ª–∏): {desire}\n"
                )
            else:
                profile = (
                    "\nüß† –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n"
                    f"- –ò–º—è/–ù–∏–∫: {answers[0] if len(answers)>0 else ''}\n"
                    f"- –í–æ–∑—Ä–∞—Å—Ç: {answers[1] if len(answers)>1 else ''}\n"
                    f"- –û–±—Ä–∞—â–µ–Ω–∏–µ: {answers[2] if len(answers)>2 else ''}\n"
                    f"- –î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {answers[3] if len(answers)>3 else ''}\n"
                    f"- –ì–ª–∞–≤–Ω—ã–µ —Ü–µ–ª–∏: {answers[4] if len(answers)>4 else ''}\n"
                    f"- –ú—ã—à–ª–µ–Ω–∏–µ: {answers[5] if len(answers)>5 else ''}\n"
                    f"- –ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞: {answers[6] if len(answers)>6 else ''}\n"
                    f"- –†–µ—à–µ–Ω–∏—è: {answers[7] if len(answers)>7 else ''}\n"
                    f"- –†–∞–∑–≤–∏—Ç–∏–µ: {answers[8] if len(answers)>8 else ''}\n"
                    f"- –¶–µ–ª—å 3‚Äì6 –º–µ—Å: {answers[9] if len(answers)>9 else ''}\n"
                )
            base += profile
            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –∏–Ω—Ç–µ—Ä–≤—å—é –≤ —è–≤–Ω–æ–º –≤–∏–¥–µ (–¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏)
            all_ans_lines = "\n".join([f"{i+1}. {a}" for i, a in enumerate(answers)])
            base += ("\nüìã –í–°–ï –û–¢–í–ï–¢–´ –ò–ù–¢–ï–†–í–¨–Æ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):\n" + all_ans_lines + "\n")
    return base

async def deepseek_request(user_message, user_history=None, user_data=None):
    try:
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {DEEPSEEK_API_KEY}"
        }
        
        messages = []
        # System prompt
        if user_data is not None:
            messages.append({"role": "system", "content": build_system_prompt(user_data)})
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
        if user_history:
            messages.extend(user_history[-10:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
        
        messages.append({"role": "user", "content": user_message})
        
        data = {
            "model": "deepseek-chat",
            "messages": messages,
            "temperature": 0.7,
            "max_tokens": 1500
        }
        
        timeout = aiohttp.ClientTimeout(total=30)
        
        async with aiohttp.ClientSession(timeout=timeout) as session:
            async with session.post(
                "https://api.deepseek.com/v1/chat/completions",
                headers=headers,
                json=data
            ) as response:
                
                if response.status == 200:
                    result = await response.json()
                    return result['choices'][0]['message']['content']
                else:
                    print(f"‚ùå API –æ—à–∏–±–∫–∞ {response.status}")
                    return None
                    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        return None

# === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    username = update.effective_user.username or "–ë–µ–∑ username"
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –±–æ—Ç–æ–≤
    if getattr(update.effective_user, 'is_bot', False):
        return
    # –ì–µ–π—Ç–∏–Ω–≥ –ø–æ —Ç–æ–∫–µ–Ω—É/whitelist –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π
    args = context.args if hasattr(context, 'args') else []
    scenario_key = None
    if args:
        raw = args[0]
        master, sep, maybe_scn = raw.partition('__')
        if sep:
            if START_TOKEN and master != START_TOKEN and (user_id not in whitelist_ids):
                await update.message.reply_text("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
                return
            scenario_key = maybe_scn if maybe_scn in SCENARIOS else None
        else:
            if START_TOKEN and raw != START_TOKEN and (user_id not in whitelist_ids):
                await update.message.reply_text("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
                return

    # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –∞–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ —Å—Å—ã–ª–∫–µ
    existing_state = user_states.get(user_id)
    if existing_state:
        # –ê–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥ /start –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥
        last_ts = existing_state.get('last_start_ts')
        now_mono = time.monotonic()
        if isinstance(last_ts, (int, float)) and (now_mono - float(last_ts) < 5):
            return
        existing_state['last_start_ts'] = now_mono

        # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ —Å—Å—ã–ª–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–µ—Ä–∞–º/–∞–¥–º–∏–Ω—É
        if scenario_key and scenario_key != existing_state.get('scenario'):
            if (user_id in whitelist_ids) or (user_id == ADMIN_CHAT_ID):
                existing_state['scenario'] = scenario_key
                existing_state['interview_stage'] = 0
                existing_state['interview_answers'] = []
                existing_state['free_used'] = 0
                existing_state['limit_notified'] = False
                scenario_cfg = SCENARIOS.get(scenario_key)
                if scenario_cfg:
                    first_q = scenario_cfg['questions'][0]
                    welcome_text = scenario_cfg['greeting'] + "\n\n" + first_q
                else:
                    welcome_text = (
                        "–ü—Ä–∏–≤–µ—Ç.\n"
                        "–Ø ‚Äî MetaPersona, –Ω–µ –±–æ—Ç –∏ –Ω–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n\n"
                        "–î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º —Å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞:\n\n"
                        "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç –∏–ª–∏ –∫–∞–∫–æ–π –Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?"
                    )
                await update.message.reply_text(welcome_text)
                existing_state['conversation_history'].append({"role": "assistant", "content": welcome_text})
                if history_sheet:
                    try:
                        history_sheet.append_row([
                            user_id,
                            scenario_key or '',
                            datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                            'assistant',
                            welcome_text,
                            existing_state.get('free_used', 0),
                            existing_state.get('daily_requests', 0),
                            existing_state.get('interview_stage', 0),
                        ])
                    except Exception as e:
                        logger.warning(f"History write error: {e}")
                if persistence:
                    try:
                        existing_state['last_activity_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                        persistence.save_user_state(user_id, existing_state, force=True)
                    except Exception as e:
                        logger.warning(f"Persist save error: {e}")
                return

        # –ò–Ω–∞—á–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π —Ç–æ—á–∫–∏
        questions = get_interview_questions(existing_state)
        if existing_state.get('interview_stage', 0) < len(questions):
            next_q = questions[existing_state['interview_stage']]
            await update.message.reply_text(next_q)
            existing_state['conversation_history'].append({"role": "assistant", "content": next_q})
            if history_sheet:
                try:
                    history_sheet.append_row([
                        user_id,
                        existing_state.get('scenario') or '',
                        datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                        'assistant',
                        next_q,
                        existing_state.get('free_used', 0),
                        existing_state.get('daily_requests', 0),
                        existing_state.get('interview_stage', 0),
                    ])
                except Exception as e:
                    logger.warning(f"History write error: {e}")
        else:
            await update.message.reply_text("–Ø –Ω–∞ —Å–≤—è–∑–∏. –ó–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.")
        # Persist (debounced)
        if persistence:
            try:
                existing_state['last_activity_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                persistence.save_user_state(user_id, existing_state)
            except Exception as e:
                logger.warning(f"Persist save error: {e}")
        return
    else:
        # –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω fallback –∏ –∑–∞–¥–∞–Ω DEFAULT_SCENARIO ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ –ø—Ä–∏ /start –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (user_id not in user_states) and ENABLE_NOARGS_SCENARIO and DEFAULT_SCENARIO and (DEFAULT_SCENARIO in SCENARIOS):
            scenario_key = DEFAULT_SCENARIO
        else:
            # –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω master-—Ç–æ–∫–µ–Ω, –∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç ‚Äî –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if START_TOKEN and (user_id not in whitelist_ids):
                await update.message.reply_text("–û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ.")
                return
    
    user_states[user_id] = {
        'interview_stage': 0,
        'daily_requests': 0,
        'last_date': datetime.now().strftime('%Y-%m-%d'),
        'interview_answers': [],
        'conversation_history': [],
        'username': username,
        'custom_limit': 10,
        'scenario': scenario_key,
        'free_used': 0,
        'limit_notified': False,
        'last_start_ts': time.monotonic(),
        'is_subscribed': False,
        'subscription_until': '',
        'last_payment_id': '',
    }
    # Persist initial state
    if persistence:
        try:
            user_states[user_id]['created_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            user_states[user_id]['last_activity_at'] = user_states[user_id]['created_at']
            persistence.save_user_state(user_id, user_states[user_id], force=True)
        except Exception as e:
            logger.warning(f"Persist init error: {e}")
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Users (Sheets)
    if users_sheet:
        try:
            # Ensure History has extended headers
            try:
                headers = history_sheet.row_values(1)
                needed = ['user_id','scenario','timestamp','role','message','free_used','daily_requests','interview_stage']
                if headers != needed:
                    history_sheet.clear()
                    history_sheet.append_row(needed)
            except Exception:
                pass
            users_sheet.append_row([
                user_id, username, 0, '', 0,
                datetime.now().strftime('%Y-%m-%d'), 10, True,
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                scenario_key or '', 0
            ])
        except Exception as e:
            logger.warning(f"Users write error: {e}")
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    scenario_cfg = SCENARIOS.get(scenario_key) if scenario_key else None
    if (scenario_cfg and scenario_cfg.get('admin_notify')) or admin_settings['notify_new_users']:
        try:
            await context.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ({scenario_key or 'default'}):\nID: {user_id}\nUsername: @{username}"
            )
        except Exception as e:
            logger.warning(f"Admin notify error: {e}")
    
    if scenario_cfg:
        # –°—Ü–µ–Ω–∞—Ä–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
        first_q = scenario_cfg['questions'][0]
        welcome_text = scenario_cfg['greeting'] + "\n\n" + first_q
    else:
        welcome_text = (
            "–ü—Ä–∏–≤–µ—Ç.\n"
            "–Ø ‚Äî MetaPersona, –Ω–µ –±–æ—Ç –∏ –Ω–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n"
            "–Ø ‚Äî –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Ç–≤–æ–µ–≥–æ –º—ã—à–ª–µ–Ω–∏—è.\n"
            "–ó–¥–µ—Å—å —Ç—ã –Ω–µ –∏—â–µ—à—å –æ—Ç–≤–µ—Ç—ã ‚Äî —Ç—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –≤–∏–¥–µ—Ç—å –∏—Ö —Å–∞–º.\n"
            "–ú–æ—è –º–∏—Å—Å–∏—è ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —Ç–µ–±–µ –º—ã—Å–ª–∏—Ç—å –≥–ª—É–±–∂–µ, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–Ω–µ–µ –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–µ–µ.\n"
            "–ß—Ç–æ–±—ã —Ç—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ ‚Äú—Ä–µ—à–∞–ª –∑–∞–¥–∞—á–∏‚Äù, –∞ —Å–æ–∑–¥–∞–≤–∞–ª —Å–º—ã—Å–ª—ã, –¥–µ–π—Å—Ç–≤–∏—è –∏ –ø–æ–ª—É—á–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.\n\n"
            "–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å ‚Äî –ø–æ–Ω—è—Ç—å —Å–µ–±—è –∏ —Å–∏—Ç—É–∞—Ü–∏—é\n"
            "–°—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç—å –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã\n"
            "–ö—Ä–µ–∞—Ç–∏–≤ ‚Äî —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤–æ–µ –∏ —Å–æ–∑–¥–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ\n"
            "¬© MetaPersona Culture 2025\n\n"
            "–î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º —Å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞:\n\n"
            "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç –∏–ª–∏ –∫–∞–∫–æ–π –Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?"
        )
    
    await update.message.reply_text(welcome_text)
    user_states[user_id]['conversation_history'].append({"role": "assistant", "content": welcome_text})
    # Log assistant welcome into History
    if history_sheet:
        try:
            scenario = user_states[user_id].get('scenario') or ''
            history_sheet.append_row([
                user_id,
                scenario,
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'assistant',
                welcome_text,
                user_states[user_id].get('free_used', 0),
                user_states[user_id].get('daily_requests', 0),
                user_states[user_id].get('interview_stage', 0),
            ])
        except Exception as e:
            logger.warning(f"History write error: {e}")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_message = update.message.text
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–æ–≤
    if getattr(update.effective_user, 'is_bot', False):
        return
    
    logger.info(f"msg from {user_id}: {user_message[:200]}")
    
    if user_id not in user_states:
        await start(update, context)
        return
    
    state = user_states[user_id]
    # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–ø–∏—Å–∫—É
    if user_id in blocked_users:
        await update.message.reply_text("‚ùå –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    state['conversation_history'].append({"role": "user", "content": user_message})
    if history_sheet:
        try:
            scenario = state.get('scenario') or ''
            history_sheet.append_row([
                user_id,
                scenario,
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'user',
                user_message,
                state.get('free_used', 0),
                state.get('daily_requests', 0),
                state.get('interview_stage', 0),
            ])
        except Exception as e:
            logger.warning(f"History write error: {e}")
    # Persist debounced
    if persistence:
        try:
            state['last_activity_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            persistence.save_user_state(user_id, state)
        except Exception as e:
            logger.warning(f"Persist save error: {e}")
    # –≠—Ö–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å)
    scenario_cfg = SCENARIOS.get(state.get('scenario')) if state.get('scenario') else None
    if (scenario_cfg and scenario_cfg.get('admin_echo')) or admin_settings['echo_user_messages']:
        try:
            await context.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"üì® {user_id} (@{state.get('username')})\n{user_message}"
            )
        except Exception as e:
            logger.warning(f"Admin echo error: {e}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
    scenario_cfg = SCENARIOS.get(state.get('scenario')) if state.get('scenario') else None
    # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ ‚Äî –ª–∏–º–∏—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã
    if is_subscription_active(state):
        pass
    elif not scenario_cfg or scenario_cfg.get('limit_mode') != 'total_free':
        # –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é: –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç
        today = datetime.now().strftime('%Y-%m-%d')
        if state['last_date'] != today:
            state['daily_requests'] = 0
            state['last_date'] = today
        limit = state.get('custom_limit', 10)
        if state['daily_requests'] >= limit:
            limit_message = (
                "–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π. –î–∏–∞–ª–æ–≥ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–µ—Ä—à—ë–Ω.\n"
                "MetaPersona –Ω–µ —Å–ø–µ—à–∏—Ç.\n"
                "–ú—ã —Ç—Ä–µ–Ω–∏—Ä—É–µ–º –Ω–µ —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî –∞ –≥–ª—É–±–∏–Ω—É –º—ã—à–ª–µ–Ω–∏—è.\n\n"
                "–ù–æ –µ—Å–ª–∏ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç,\n"
                "–∏ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî\n"
                "—Ç–∞–º, –≥–¥–µ –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π,\n\n"
                "üîó –°–æ–∑–¥–∞–π —Å–≤–æ—é MetaPersona —Å–µ–π—á–∞—Å (—Å—Å—ã–ª–∫–∞ https://taplink.cc/metapersona). \n\n"
                "15 –º–∏–Ω—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –∏ —Ç—ã –∑–∞–ø—É—Å—Ç–∏—à—å —Å–≤–æ—é AI-–ª–∏—á–Ω–æ—Å—Ç—å,\n"
                "–∫–æ—Ç–æ—Ä–∞—è –∑–Ω–∞–µ—Ç —Ç–≤–æ–π —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è, —Ü–µ–ª–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç–º.\n\n"
                "–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∞—Ç. –≠—Ç–æ –Ω–∞—á–∞–ª–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è.\n\n"
                "¬© MetaPersona Culture 2025"
            )
            await update.message.reply_text(limit_message)
            state['conversation_history'].append({"role": "assistant", "content": limit_message})
            return
    
    # –≠–¢–ê–ü 1: –ò–ù–¢–ï–†–í–¨–Æ (–ë–ï–ó –ó–ê–ü–†–û–°–û–í –ö –ò–ò)
    questions = get_interview_questions(state)
    if state['interview_stage'] < len(questions):
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å
        if state['interview_stage'] > 0:
            state['interview_answers'].append(user_message)
        
        state['interview_stage'] += 1
        
        if state['interview_stage'] < len(questions):
            next_question = questions[state['interview_stage']]
            await update.message.reply_text(next_question)
            state['conversation_history'].append({"role": "assistant", "content": next_question})
            if history_sheet:
                try:
                    history_sheet.append_row([
                        user_id,
                        state.get('scenario') or '',
                        datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                        'assistant',
                        next_question,
                        state.get('free_used', 0),
                        state.get('daily_requests', 0),
                        state.get('interview_stage', 0),
                    ])
                except Exception as e:
                    logger.warning(f"History write error: {e}")
        else:
            # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é
            state['interview_answers'].append(user_message)
            # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–≤–æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤—å—é –¥–ª—è Vlasta ‚Äî –º—è–≥–∫–∏–π –º–æ—Å—Ç –≤ —Å–µ—Å—Å–∏—é
            completion_text = (
                "üéâ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É –º–µ–Ω—è –µ—Å—Ç—å –ø–µ—Ä–≤—ã–π –Ω–∞–±—Ä–æ—Å–æ–∫ —Ç–≤–æ–µ–π –¥–∏–Ω–∞–º–∏–∫–∏.\n\n"
                "–î–∞–ª—å—à–µ ‚Äî –Ω–µ —Ç–µ–æ—Ä–∏—è, –∞ –ø—Ä–∞–∫—Ç–∏–∫–∞. –û—Ç–≤–µ—á–∞—è –Ω–∞ —Ç–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è, —è –±—É–¥—É:\n"
                "‚Ä¢ –î–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –≥–æ—Ç–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã,\n"
                "‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å –º–µ–Ω—è—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è —Ç–∞–º, –≥–¥–µ —Ä–∞–Ω—å—à–µ —Ç—ã —É–ø–∏—Ä–∞–ª–∞—Å—å –≤ —Å—Ç–µ–Ω—É,\n"
                "‚Ä¢ –°–ª–µ–¥–∏—Ç—å, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —à–∞–≥ –¥–∞–≤–∞–ª —Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.\n\n"
                "–ó–∞–¥–∞–π —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî –∏ –Ω–∞—á–Ω—ë–º."
            )
            await update.message.reply_text(completion_text)
            state['conversation_history'].append({"role": "assistant", "content": completion_text})
            if history_sheet:
                try:
                    history_sheet.append_row([
                        user_id,
                        state.get('scenario') or '',
                        datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                        'assistant',
                        completion_text,
                        state.get('free_used', 0),
                        state.get('daily_requests', 0),
                        state.get('interview_stage', 0),
                    ])
                except Exception as e:
                    logger.warning(f"History write error: {e}")
        return
    
    # –≠–¢–ê–ü 2: –î–ò–ê–õ–û–ì –° AI (–° –ò–°–¢–û–†–ò–ï–ô)
    if is_subscription_active(state):
        pass
    elif not scenario_cfg or scenario_cfg.get('limit_mode') != 'total_free':
        state['daily_requests'] += 1
    
    await update.message.reply_text("üí≠ –î—É–º–∞—é...")
    
    # –°—Ü–µ–Ω–∞—Ä–Ω—ã–π —Ä–∞–∑–æ–≤—ã–π –ª–∏–º–∏—Ç (Vlasta): –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ñ—Ñ–µ—Ä —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 5 –æ—Ç–≤–µ—Ç–æ–≤
    if not is_subscription_active(state) and scenario_cfg and scenario_cfg.get('limit_mode') == 'total_free':
        free_used = state.get('free_used', 0)
        free_limit = int(scenario_cfg.get('limit_value', 5))
        if free_used >= free_limit and not state.get('limit_notified', False):
            lm = scenario_cfg.get('limit_message')
            if lm:
                await update.message.reply_text(lm)
                state['conversation_history'].append({"role": "assistant", "content": lm})
                state['limit_notified'] = True
                # –ê–≤—Ç–æ–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä
                try:
                    if PAYMENT_PROVIDER_TOKEN:
                        await send_invoice_to_user(context, user_id)
                except Exception as e:
                    logger.warning(f"Auto-invoice error: {e}")
            return
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ò–ò
    bot_response = await deepseek_request(user_message, state['conversation_history'], state)
    
    if bot_response:
        await update.message.reply_text(bot_response)
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        state['conversation_history'].append({"role": "assistant", "content": bot_response})
        if history_sheet:
            try:
                history_sheet.append_row([
                    user_id,
                    state.get('scenario') or '',
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    'assistant',
                    bot_response,
                    state.get('free_used', 0),
                    state.get('daily_requests', 0),
                    state.get('interview_stage', 0),
                ])
            except Exception as e:
                logger.warning(f"History write error: {e}")
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 15 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if len(state['conversation_history']) > 15:
            state['conversation_history'] = state['conversation_history'][-15:]
        # –£—á–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é
        if not is_subscription_active(state) and scenario_cfg and scenario_cfg.get('limit_mode') == 'total_free':
            state['free_used'] = state.get('free_used', 0) + 1
            free_limit = int(scenario_cfg.get('limit_value', 5))
            if state['free_used'] >= free_limit and not state.get('limit_notified', False):
                lm = scenario_cfg.get('limit_message')
                if lm:
                    await update.message.reply_text(lm)
                    state['conversation_history'].append({"role": "assistant", "content": lm})
                    state['limit_notified'] = True
                # –ê–≤—Ç–æ–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä
                try:
                    if PAYMENT_PROVIDER_TOKEN:
                        await send_invoice_to_user(context, user_id)
                except Exception as e:
                    logger.warning(f"Auto-invoice error: {e}")
    else:
        import random
        # –ö–æ–º–ø–ª–∞–µ–Ω—Ç–Ω—ã–µ fallback-–æ—Ç–≤–µ—Ç—ã –±–µ–∑ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
        fallbacks = [
            "–î–∞–π –æ–¥–Ω—É –¥–µ—Ç–∞–ª—å: –≤ –∫–∞–∫–æ–π –º–æ–º–µ–Ω—Ç –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ —Ç—ã –ø–æ–Ω—è–ª–∞, —á—Ç–æ –æ–Ω –Ω–µ —Å–ª—ã—à–∏—Ç? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–æ—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.",
            "–ü–æ–ø—Ä–æ–±—É–π —Å–µ–≥–æ–¥–Ω—è —Å–∫–∞–∑–∞—Ç—å: ¬´–°–µ–π—á–∞—Å –º–Ω–µ –≤–∞–∂–Ω–∞ —Ç–≤–æ—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –∞ –Ω–µ —Ä–µ—à–µ–Ω–∏–µ¬ª. –°–æ–æ–±—â–∏ –µ–≥–æ —Ä–µ–∞–∫—Ü–∏—é ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É.",
            "–í—ã–±–µ—Ä–∏ –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ: —Å–º–µ–Ω–∏—Ç—å —Ç–æ–Ω, –∑–∞–¥–∞—Ç—å —Ä–∞–º–∫—É –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –æ–±–æ–∑–Ω–∞—á–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—É. –ö–∞–∫–æ–π —à–∞–≥ —Å–¥–µ–ª–∞–µ—à—å –ø–µ—Ä–≤—ã–º?"
        ]
        fallback_response = random.choice(fallbacks)
        await update.message.reply_text(fallback_response)
        state['conversation_history'].append({"role": "assistant", "content": fallback_response})
        if history_sheet:
            try:
                history_sheet.append_row([
                    user_id,
                    state.get('scenario') or '',
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    'assistant',
                    fallback_response,
                    state.get('free_used', 0),
                    state.get('daily_requests', 0),
                    state.get('interview_stage', 0),
                ])
            except Exception as e:
                logger.warning(f"History write error: {e}")

# === –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´ ===
async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    total_users = len(user_states)
    today = datetime.now().strftime('%Y-%m-%d')
    active_today = sum(1 for u in user_states.values() if u['last_date'] == today)
    blocked = len(blocked_users)
    await update.message.reply_text(
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\nüë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {total_users}\nüü¢ –ê–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è: {active_today}\nüö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã: {blocked}"
    )

async def admin_block(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /block <user_id>")
        return
    try:
        uid = int(context.args[0])
        blocked_users.add(uid)
        await update.message.reply_text(f"‚úÖ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω {uid}")
    except Exception:
        await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id")

async def admin_unblock(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unblock <user_id>")
        return
    try:
        uid = int(context.args[0])
        blocked_users.discard(uid)
        await update.message.reply_text(f"‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω {uid}")
    except Exception:
        await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id")

async def admin_setlimit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    if len(context.args) != 2:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /setlimit <user_id> <limit>")
        return
    try:
        uid = int(context.args[0]); limit = int(context.args[1])
        if uid in user_states:
            user_states[uid]['custom_limit'] = limit
            await update.message.reply_text(f"‚úÖ –õ–∏–º–∏—Ç {uid}: {limit}")
        else:
            await update.message.reply_text("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception:
        await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")

async def admin_notify(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    if not context.args or context.args[0] not in ('on','off'):
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /notify on|off")
        return
    admin_settings['notify_new_users'] = (context.args[0] == 'on')
    await update.message.reply_text(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {'–≤–∫–ª' if admin_settings['notify_new_users'] else '–≤—ã–∫–ª'}")

async def admin_echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    if not context.args or context.args[0] not in ('on','off'):
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /echo on|off")
        return
    admin_settings['echo_user_messages'] = (context.args[0] == 'on')
    await update.message.reply_text(f"‚úÖ –≠—Ö–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {'–≤–∫–ª' if admin_settings['echo_user_messages'] else '–≤—ã–∫–ª'}")

async def admin_whitelist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        return
    if len(context.args) != 2 or context.args[0] not in ('add','remove'):
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /whitelist add|remove <user_id>")
        return
    try:
        uid = int(context.args[1])
        if context.args[0] == 'add':
            whitelist_ids.add(uid)
            await update.message.reply_text(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ whitelist: {uid}")
        else:
            whitelist_ids.discard(uid)
            await update.message.reply_text(f"‚úÖ –£–¥–∞–ª—ë–Ω –∏–∑ whitelist: {uid}")
    except Exception:
        await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id")

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    logger.exception("Unhandled exception in handler", exc_info=context.error)

# === –ó–ê–ü–£–°–ö ===
def main():
    logger.info("Starting MetaPersona Bot...")

    async def run_server():
        # Build application without Updater (custom webhook server)
        application = Application.builder().updater(None).token(BOT_TOKEN).build()

        # Handlers
        application.add_handler(CommandHandler("start", start))
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        application.add_handler(CommandHandler("stats", admin_stats))
        application.add_handler(CommandHandler("block", admin_block))
        application.add_handler(CommandHandler("unblock", admin_unblock))
        application.add_handler(CommandHandler("setlimit", admin_setlimit))
        application.add_handler(CommandHandler("notify", admin_notify))
        application.add_handler(CommandHandler("echo", admin_echo))
        application.add_handler(CommandHandler("whitelist", admin_whitelist))
        application.add_error_handler(error_handler)

        # Admin diagnostics
        async def diag_webhook(update: Update, context: ContextTypes.DEFAULT_TYPE):
            if update.effective_user.id != ADMIN_CHAT_ID:
                return
            try:
                info = await application.bot.get_webhook_info()
                txt = (
                    f"url: {info.url or '-'}\n"
                    f"has_custom_certificate: {info.has_custom_certificate}\n"
                    f"pending_update_count: {info.pending_update_count}\n"
                    f"ip_address: {getattr(info, 'ip_address', '-') }\n"
                    f"last_error_date: {getattr(info, 'last_error_date', '-') }\n"
                    f"last_error_message: {getattr(info, 'last_error_message', '-') }"
                )
                await update.message.reply_text(f"Webhook info:\n{txt}")
            except Exception as e:
                await update.message.reply_text(f"diag_webhook error: {e}")

        async def reset_webhook(update: Update, context: ContextTypes.DEFAULT_TYPE):
            if update.effective_user.id != ADMIN_CHAT_ID:
                return
            try:
                base_url = os.environ.get('WEBHOOK_BASE_URL') or os.environ.get('RENDER_EXTERNAL_URL')
                if not base_url:
                    await update.message.reply_text('WEBHOOK_BASE_URL/RENDER_EXTERNAL_URL –Ω–µ –∑–∞–¥–∞–Ω')
                    return
                url_path = f"/webhook/{BOT_TOKEN}"
                webhook_url = base_url.rstrip('/') + url_path
                await application.bot.set_webhook(webhook_url, drop_pending_updates=False, allowed_updates=Update.ALL_TYPES)
                info = await application.bot.get_webhook_info()
                await update.message.reply_text(f"Webhook reset to: {info.url}\nPending: {info.pending_update_count}")
            except Exception as e:
                await update.message.reply_text(f"reset_webhook error: {e}")

        application.add_handler(CommandHandler("diag_webhook", diag_webhook))
        application.add_handler(CommandHandler("reset_webhook", reset_webhook))

        # Admin: export subscriptions (CSV-like to chat for now)
        async def export_subscriptions(update: Update, context: ContextTypes.DEFAULT_TYPE):
            if update.effective_user.id != ADMIN_CHAT_ID:
                return
            rows = []
            for uid, st in user_states.items():
                rows.append(
                    f"{uid}, {st.get('username','')}, {st.get('is_subscribed',False)}, {st.get('subscription_until','')}"
                )
            if not rows:
                await update.message.reply_text("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫")
            else:
                head = "user_id, username, is_subscribed, subscription_until\n"
                await update.message.reply_text(head + "\n".join(rows))

        # Admin: quick state peek
        async def state_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
            if update.effective_user.id != ADMIN_CHAT_ID:
                return
            if not context.args:
                await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /state <user_id>")
                return
            try:
                uid = int(context.args[0])
                st = user_states.get(uid)
                if not st:
                    await update.message.reply_text("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–º—è—Ç–∏")
                    return
                keys = ['scenario','interview_stage','free_used','daily_requests','last_date','is_subscribed','subscription_until']
                lines = [f"{k}: {st.get(k)}" for k in keys]
                await update.message.reply_text("\n".join(lines))
            except Exception as e:
                await update.message.reply_text(f"state error: {e}")

        # Admin: backup states (flush all to Sheets)
        async def backup_states(update: Update, context: ContextTypes.DEFAULT_TYPE):
            if update.effective_user.id != ADMIN_CHAT_ID:
                return
            try:
                if persistence:
                    persistence.flush_all(user_states)
                    await update.message.reply_text(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π: {len(user_states)}")
                else:
                    await update.message.reply_text("Persistence –æ—Ç–∫–ª—é—á–µ–Ω")
            except Exception as e:
                await update.message.reply_text(f"backup error: {e}")

        application.add_handler(CommandHandler("export_subscriptions", export_subscriptions))
        application.add_handler(CommandHandler("state", state_cmd))
        application.add_handler(CommandHandler("backup_states", backup_states))

        # === Billing/Payments Handlers ===
        async def send_invoice(update: Update, context: ContextTypes.DEFAULT_TYPE):
            user_id = update.effective_user.id
            if user_id not in user_states:
                await start(update, context); return
            # Price: Telegram expects integer of the smallest currency unit (kopecks)
            total_kopecks = int(round(VLASTA_PRICE_RUB * 100))
            prices = [LabeledPrice(label="–î–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π –∫ Vlasta", amount=total_kopecks)]

            # Provider data with receipt items and tax system (–Æ–ö–∞—Å—Å–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —á–µ–∫, email —Å–ø—Ä–æ—Å–∏—Ç –Ω–∞ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Ñ–æ—Ä–º–µ)
            provider_data = {
                "receipt": {
                    # customer email/phone –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º ‚Äî –≤–∫–ª—é—á–∏–º need_email/send_email_to_provider
                    "items": [
                        {
                            "description": "–î–æ—Å—Ç—É–ø –∫ Vlasta –Ω–∞ 7 –¥–Ω–µ–π",
                            "quantity": 1,
                            "amount": {"value": VLASTA_PRICE_RUB, "currency": "RUB"},
                            "vat_code": VAT_CODE,
                            "payment_mode": "full_payment",
                            "payment_subject": "service"
                        }
                    ],
                    "tax_system_code": TAX_SYSTEM_CODE
                }
            }

            await context.bot.send_invoice(
                chat_id=user_id,
                title="Vlasta ‚Äî –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π",
                description=(
                    "–ù–µ–¥–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏,\n"
                    "—Ä–∞–∑–±–æ—Ä —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è."
                ),
                payload=f"vlasta_week_{user_id}_{int(time.time())}",
                provider_token=PAYMENT_PROVIDER_TOKEN,
                currency="RUB",
                prices=prices,
                need_email=True,
                send_email_to_provider=True,
                need_phone_number=False,
                send_phone_number_to_provider=False,
                provider_data=json.dumps(provider_data, ensure_ascii=False)
            )

        async def precheckout_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
            query = update.pre_checkout_query
            try:
                await query.answer(ok=True)
            except Exception:
                await query.answer(ok=False, error_message="–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–ª–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

        async def successful_payment_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
            user_id = update.effective_user.id
            state = user_states.get(user_id)
            if not state:
                return
            # Activate 7-day subscription window
            until = (datetime.now() + timedelta(days=7)).strftime('%Y-%m-%d %H:%M:%S')
            state['is_subscribed'] = True
            state['subscription_until'] = until
            state['last_payment_id'] = getattr(update.message.successful_payment, 'provider_payment_charge_id', '')
            # Reset scenario counters if needed
            state['daily_requests'] = 0
            state['free_used'] = 0
            # Persist immediately
            if persistence:
                try:
                    state['last_activity_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                    persistence.save_user_state(user_id, state, force=True)
                except Exception as e:
                    logger.warning(f"Persist after payment error: {e}")
            # Send subscription welcome if scenario provides
            scenario_cfg = SCENARIOS.get(state.get('scenario')) if state.get('scenario') else None
            sub_welcome = scenario_cfg.get('subscription_welcome') if scenario_cfg else None
            if sub_welcome:
                await update.message.reply_text(sub_welcome)
            else:
                await update.message.reply_text(
                    "–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞. –î–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω."
                )

        application.add_handler(CommandHandler("buy", send_invoice))
        application.add_handler(PreCheckoutQueryHandler(precheckout_callback))
        application.add_handler(MessageHandler(filters.SUCCESSFUL_PAYMENT, successful_payment_handler))

        # Restore states at startup (last 14 days)
        restored = 0
        if persistence:
            try:
                all_states = persistence.load_all_states()
                for uid, st in all_states.items():
                    last_at = st.get('last_activity_at') or st.get('updated_at')
                    ok = True
                    if last_at:
                        try:
                            dt = datetime.strptime(last_at, '%Y-%m-%d %H:%M:%S')
                            ok = (datetime.now() - dt).days <= 14
                        except Exception:
                            ok = True
                    if ok:
                        # ensure required fields
                        st.setdefault('conversation_history', [])
                        st.setdefault('interview_answers', [])
                        st.setdefault('interview_stage', 0)
                        st.setdefault('daily_requests', 0)
                        st.setdefault('custom_limit', 10)
                        st.setdefault('free_used', 0)
                        user_states[uid] = st
                        restored += 1
                try:
                    removed = persistence.prune_old(14)
                    if removed:
                        logger.info(f"States pruned: {removed}")
                except Exception:
                    pass
            except Exception as e:
                logger.warning(f"States restore error: {e}")
        logger.info(f"States restored: {restored}")

        port = int(os.environ.get('PORT', '10000'))
        base_url = os.environ.get('WEBHOOK_BASE_URL') or os.environ.get('RENDER_EXTERNAL_URL')
        if not base_url:
            raise RuntimeError('WEBHOOK_BASE_URL/RENDER_EXTERNAL_URL –Ω–µ –∑–∞–¥–∞–Ω')
        url_path = f"/webhook/{BOT_TOKEN}"
        webhook_url = base_url.rstrip('/') + url_path
        logger.info(f"Webhook: {webhook_url} on port {port}")

        # aiohttp app
        aio = web.Application()

        async def handle_health(request: web.Request):
            return web.Response(text='OK')

        async def _process_update_payload(data: dict):
            try:
                upd = Update.de_json(data, application.bot)
                await application.process_update(upd)
            except Exception as e:
                logger.exception(f"Update processing error: {e}")

        async def handle_tg(request: web.Request):
            data = await request.json()
            logger.info("Webhook hit: received update (token path)")
            await _process_update_payload(data)
            return web.Response(text='OK')

        async def handle_tg_short(request: web.Request):
            # Validate secret token if configured
            if WEBHOOK_SECRET:
                got = request.headers.get('X-Telegram-Bot-Api-Secret-Token')
                if got != WEBHOOK_SECRET:
                    logger.warning("Webhook short path: invalid secret token")
                    return web.Response(status=403, text='Forbidden')
            data = await request.json()
            logger.info("Webhook hit: received update (short path)")
            await _process_update_payload(data)
            return web.Response(text='OK')

        aio.router.add_get('/health', handle_health)
        aio.router.add_post(url_path, handle_tg)          # token path
        aio.router.add_post('/webhook', handle_tg_short)   # short alias path

        # Start app and webhook
        await application.initialize()
        await application.start()
        runner = web.AppRunner(aio)
        await runner.setup()
        site = web.TCPSite(runner, '0.0.0.0', port)
        await site.start()
        logger.info('Aiohttp server started')
        # Prefer short path with secret if configured; fallback to token path; don't crash on failure
        short_url = base_url.rstrip('/') + '/webhook'
        # default expected url
        heal_expected_url = short_url if WEBHOOK_SECRET else webhook_url
        try:
            if WEBHOOK_SECRET:
                await application.bot.set_webhook(short_url, secret_token=WEBHOOK_SECRET, drop_pending_updates=False, allowed_updates=Update.ALL_TYPES)
                heal_expected_url = short_url
                logger.info(f"Webhook set to short path with secret: {short_url}")
            else:
                await application.bot.set_webhook(webhook_url, drop_pending_updates=False, allowed_updates=Update.ALL_TYPES)
                heal_expected_url = webhook_url
                logger.info(f"Webhook set to token path: {webhook_url}")
        except Exception as e:
            logger.warning(f"Initial set_webhook failed: {e}")
            try:
                await application.bot.set_webhook(webhook_url, drop_pending_updates=False, allowed_updates=Update.ALL_TYPES)
                heal_expected_url = webhook_url
                logger.info(f"Webhook fallback to token path: {webhook_url}")
            except Exception as e2:
                logger.warning(f"Fallback set_webhook failed: {e2}")
                heal_expected_url = webhook_url
        # Graceful stop support
        stop_event = asyncio.Event()

        loop = asyncio.get_running_loop()

        def _handle_stop():
            try:
                stop_event.set()
            except Exception:
                pass

        try:
            loop.add_signal_handler(signal.SIGTERM, _handle_stop)
            loop.add_signal_handler(signal.SIGINT, _handle_stop)
        except NotImplementedError:
            # Signals not available (e.g., on Windows) ‚Äî ignore
            pass

        # Background self-heal task
        async def webhook_self_heal():
            nonlocal heal_expected_url
            interval = int(os.environ.get('WEBHOOK_HEALTH_INTERVAL_SECS', '60'))
            while True:
                try:
                    await asyncio.sleep(interval)
                    info = await application.bot.get_webhook_info()
                    expected = heal_expected_url or (short_url if WEBHOOK_SECRET else webhook_url)
                    if not info.url or info.url != expected:
                        try:
                            if WEBHOOK_SECRET:
                                await application.bot.set_webhook(short_url, secret_token=WEBHOOK_SECRET, drop_pending_updates=False, allowed_updates=Update.ALL_TYPES)
                                logger.info("Webhook self-healed to short path")
                                heal_expected_url = short_url
                            else:
                                await application.bot.set_webhook(webhook_url, drop_pending_updates=False, allowed_updates=Update.ALL_TYPES)
                                logger.info("Webhook self-healed to token path")
                                heal_expected_url = webhook_url
                        except Exception as se:
                            logger.warning(f"Webhook self-heal error: {se}")
                except asyncio.CancelledError:
                    break
                except Exception as he:
                    logger.warning(f"Webhook health loop error: {he}")

        heal_task = asyncio.create_task(webhook_self_heal())

        try:
            await stop_event.wait()
        finally:
            try:
                await application.bot.delete_webhook(drop_pending_updates=False)
            except Exception:
                pass
            # Flush all states before shutdown
            if persistence:
                try:
                    persistence.flush_all(user_states)
                    logger.info(f"States flushed: {len(user_states)}")
                except Exception as e:
                    logger.warning(f"States flush error: {e}")
            try:
                heal_task.cancel()
                await heal_task
            except Exception:
                pass
            await application.stop()
            await application.shutdown()
            await runner.cleanup()

    try:
        asyncio.run(run_server())
    except Exception as e:
        logger.exception(f"Startup error: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()
